"""
Shell Completions - Generate shell completion scripts for spectra.

Supports Bash, Zsh, and Fish shells.
"""

from typing import Optional


# Embedded completion scripts (for dynamic generation)
BASH_COMPLETION = '''#!/bin/bash
# Bash completion script for spectra
# Generated by: spectra --completions bash

_spectra_completions() {
    local cur prev opts
    COMPREPLY=()
    cur="${COMP_WORDS[COMP_CWORD]}"
    prev="${COMP_WORDS[COMP_CWORD-1]}"
    
    # All available options
    opts="--markdown -m --epic -e --execute -x --no-confirm --phase --story --config -c --jira-url --project --verbose -v --quiet -q --output -o --no-color --export --validate --interactive -i --resume --resume-session --list-sessions --version --help -h --completions"
    
    # Phase choices
    phases="all descriptions subtasks comments statuses"
    
    # Handle option-specific completions
    case "${prev}" in
        --markdown|-m)
            COMPREPLY=( $(compgen -f -X '!*.md' -- "${cur}") )
            COMPREPLY+=( $(compgen -d -- "${cur}") )
            return 0
            ;;
        --config|-c)
            COMPREPLY=( $(compgen -f -X '!*.yaml' -- "${cur}") )
            COMPREPLY+=( $(compgen -f -X '!*.yml' -- "${cur}") )
            COMPREPLY+=( $(compgen -f -X '!*.toml' -- "${cur}") )
            COMPREPLY+=( $(compgen -d -- "${cur}") )
            return 0
            ;;
        --export)
            COMPREPLY=( $(compgen -f -X '!*.json' -- "${cur}") )
            COMPREPLY+=( $(compgen -d -- "${cur}") )
            return 0
            ;;
        --phase)
            COMPREPLY=( $(compgen -W "${phases}" -- "${cur}") )
            return 0
            ;;
        --completions)
            COMPREPLY=( $(compgen -W "bash zsh fish" -- "${cur}") )
            return 0
            ;;
        --output|-o)
            COMPREPLY=( $(compgen -W "text json" -- "${cur}") )
            return 0
            ;;
        --epic|-e|--story|--jira-url|--project)
            return 0
            ;;
    esac
    
    if [[ "${cur}" == -* ]]; then
        COMPREPLY=( $(compgen -W "${opts}" -- "${cur}") )
        return 0
    fi
    
    COMPREPLY=( $(compgen -f -- "${cur}") )
}

complete -F _spectra_completions spectra
'''

ZSH_COMPLETION = '''#compdef spectra
# Zsh completion script for spectra
# Generated by: spectra --completions zsh

_spectra() {
    local curcontext="$curcontext" state line
    typeset -A opt_args
    
    local -a phases
    phases=(
        'all:Run all sync phases'
        'descriptions:Sync story descriptions only'
        'subtasks:Sync subtasks only'
        'comments:Sync comments only'
        'statuses:Sync statuses only'
    )
    
    local -a shells
    shells=(
        'bash:Generate Bash completion script'
        'zsh:Generate Zsh completion script'
        'fish:Generate Fish completion script'
    )
    
    _arguments -C \\
        '(-m --markdown)'{-m,--markdown}'[Path to markdown epic file]:markdown file:_files -g "*.md"' \\
        '(-e --epic)'{-e,--epic}'[Jira epic key (e.g., PROJ-123)]:epic key:' \\
        '(-x --execute)'{-x,--execute}'[Execute changes (default is dry-run)]' \\
        '--no-confirm[Skip confirmation prompts]' \\
        '--phase[Which phase to run]:phase:->phases' \\
        '--story[Filter to specific story ID]:story id:' \\
        '(-c --config)'{-c,--config}'[Path to config file]:config file:_files -g "*.{yaml,yml,toml}"' \\
        '--jira-url[Override Jira URL]:url:_urls' \\
        '--project[Override Jira project key]:project key:' \\
        '(-v --verbose)'{-v,--verbose}'[Verbose output]' \\
        '(-q --quiet)'{-q,--quiet}'[Quiet mode - only show errors and summary]' \\
        '(-o --output)'{-o,--output}'[Output format]:format:(text json)' \\
        '--no-color[Disable colored output]' \\
        '--export[Export analysis to JSON file]:json file:_files -g "*.json"' \\
        '--validate[Validate markdown file format]' \\
        '(-i --interactive)'{-i,--interactive}'[Interactive mode with step-by-step guided sync]' \\
        '--resume[Resume an interrupted sync session]' \\
        '--resume-session[Resume a specific sync session by ID]:session id:' \\
        '--list-sessions[List all resumable sync sessions]' \\
        '--version[Show version and exit]' \\
        '--completions[Generate shell completion script]:shell:->shells' \\
        '(-h --help)'{-h,--help}'[Show help message]' \\
        '*:markdown file:_files -g "*.md"'
    
    case "$state" in
        phases)
            _describe -t phases 'sync phase' phases
            ;;
        shells)
            _describe -t shells 'shell type' shells
            ;;
    esac
}

_spectra "$@"
'''

FISH_COMPLETION = '''# Fish completion script for spectra
# Generated by: spectra --completions fish

complete -c spectra -f

# Required arguments
complete -c spectra -s m -l markdown -d 'Path to markdown epic file' -r -F -a '*.md'
complete -c spectra -s e -l epic -d 'Jira epic key (e.g., PROJ-123)' -x

# Execution mode
complete -c spectra -s x -l execute -d 'Execute changes (default is dry-run)'
complete -c spectra -l no-confirm -d 'Skip confirmation prompts'

# Phase control
complete -c spectra -l phase -d 'Which phase to run' -x -a '
    all\\t"Run all sync phases"
    descriptions\\t"Sync story descriptions only"
    subtasks\\t"Sync subtasks only"
    comments\\t"Sync comments only"
    statuses\\t"Sync statuses only"
'

# Filters
complete -c spectra -l story -d 'Filter to specific story ID (e.g., US-001)' -x

# Configuration
complete -c spectra -s c -l config -d 'Path to config file' -r -F -a '*.yaml *.yml *.toml'
complete -c spectra -l jira-url -d 'Override Jira URL' -x
complete -c spectra -l project -d 'Override Jira project key' -x

# Output options
complete -c spectra -s v -l verbose -d 'Verbose output'
complete -c spectra -s q -l quiet -d 'Quiet mode - only show errors and summary'
complete -c spectra -s o -l output -d 'Output format' -x -a 'text json'
complete -c spectra -l no-color -d 'Disable colored output'
complete -c spectra -l export -d 'Export analysis to JSON file' -r -F -a '*.json'

# Special modes
complete -c spectra -l validate -d 'Validate markdown file format'
complete -c spectra -s i -l interactive -d 'Interactive mode with step-by-step guided sync'
complete -c spectra -l resume -d 'Resume an interrupted sync session'
complete -c spectra -l resume-session -d 'Resume a specific sync session by ID' -x
complete -c spectra -l list-sessions -d 'List all resumable sync sessions'
complete -c spectra -l version -d 'Show version and exit'
complete -c spectra -s h -l help -d 'Show help message'

# Shell completions
complete -c spectra -l completions -d 'Generate shell completion script' -x -a '
    bash\\t"Generate Bash completion script"
    zsh\\t"Generate Zsh completion script"  
    fish\\t"Generate Fish completion script"
'
'''


def get_completion_script(shell: str) -> Optional[str]:
    """
    Get the completion script for a specific shell.
    
    Args:
        shell: Shell type ('bash', 'zsh', or 'fish').
        
    Returns:
        The completion script as a string, or None if shell is not supported.
    """
    scripts = {
        'bash': BASH_COMPLETION,
        'zsh': ZSH_COMPLETION,
        'fish': FISH_COMPLETION,
    }
    return scripts.get(shell.lower())


def get_installation_instructions(shell: str) -> str:
    """
    Get installation instructions for a specific shell.
    
    Args:
        shell: Shell type ('bash', 'zsh', or 'fish').
        
    Returns:
        Installation instructions as a string.
    """
    shell = shell.lower()
    
    if shell == 'bash':
        return """
# Bash Completion Installation

Option 1: Add to ~/.bashrc
  echo 'eval "$(spectra --completions bash)"' >> ~/.bashrc
  source ~/.bashrc

Option 2: Save to file and source
  spectra --completions bash > ~/.local/share/bash-completion/completions/spectra
  
Option 3: System-wide (requires sudo)
  sudo spectra --completions bash > /etc/bash_completion.d/spectra
"""

    elif shell == 'zsh':
        return """
# Zsh Completion Installation

Option 1: Add to ~/.zshrc
  echo 'eval "$(spectra --completions zsh)"' >> ~/.zshrc
  source ~/.zshrc

Option 2: Save to completions directory
  mkdir -p ~/.zsh/completions
  spectra --completions zsh > ~/.zsh/completions/_spectra
  # Add to ~/.zshrc: fpath=(~/.zsh/completions $fpath)
  # Then run: autoload -Uz compinit && compinit
"""

    elif shell == 'fish':
        return """
# Fish Completion Installation

Option 1: Add to config.fish
  echo 'spectra --completions fish | source' >> ~/.config/fish/config.fish

Option 2: Save to completions directory
  spectra --completions fish > ~/.config/fish/completions/spectra.fish
"""

    return f"Unknown shell: {shell}. Supported shells: bash, zsh, fish"


def print_completion(shell: str) -> bool:
    """
    Print the completion script for a specific shell.
    
    Args:
        shell: Shell type ('bash', 'zsh', or 'fish').
        
    Returns:
        True if script was printed, False if shell is not supported.
    """
    script = get_completion_script(shell)
    if script:
        print(script)
        return True
    
    print(f"Error: Unknown shell '{shell}'. Supported shells: bash, zsh, fish")
    return False


SUPPORTED_SHELLS = ['bash', 'zsh', 'fish']

